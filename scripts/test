#!/usr/bin/env bash
set -euo pipefail

# Isolate test environment from user config
export XDG_CONFIG_HOME="$(pwd)/.test"
export XDG_DATA_HOME="$(pwd)/.test"
export XDG_STATE_HOME="$(pwd)/.test"

echo "Compiling Fennel files..."

# Compile all Fennel files first
nvim --headless \
    --noplugin \
    -u .test/init.lua \
    -c "lua require('nfnl').setup()" \
    -c "lua require('nfnl.api').compile_all_files()" \
    -c "qa!"

echo "Compilation complete."
echo ""
echo "Running tests..."

# Run tests using nvim -l (runs Lua file directly)
nvim --headless -l .test/run_tests.lua

exit_code=$?
echo ""
if [ $exit_code -eq 0 ]; then
    echo "All tests passed!"
else
    echo "Tests failed with exit code: $exit_code"
fi

exit $exit_code
