#!/usr/bin/env bash
set -euo pipefail

# Isolate test environment from user config
export XDG_CONFIG_HOME="$(pwd)/.test"
export XDG_DATA_HOME="$(pwd)/.test"
export XDG_STATE_HOME="$(pwd)/.test"

echo "Compiling Fennel files..."

# Compile Fennel test files using Fennel directly (bypasses nfnl trust)
# nfnl bundles Fennel, so we use it from there
nvim --headless \
    -u .test/init.lua \
    -c "lua local fennel = require('nfnl.fennel'); local function compile_file(src, dest) local f = io.open(src, 'r'); if not f then return end; local code = f:read('*a'); f:close(); local lua_code = fennel.compileString(code, {filename = src}); vim.fn.mkdir(vim.fn.fnamemodify(dest, ':h'), 'p'); local out = io.open(dest, 'w'); out:write(lua_code); out:close(); print('Compiled: ' .. src .. ' -> ' .. dest); end; for _, fnl_file in ipairs(vim.fn.glob('fnl/longway-spec/**/*.fnl', false, true)) do local lua_file = fnl_file:gsub('^fnl/', 'lua/'):gsub('%.fnl$', '.lua'); compile_file(fnl_file, lua_file); end" \
    -c "qa!"

compile_exit=$?
if [ $compile_exit -ne 0 ]; then
    echo "ERROR: Fennel compilation failed"
    exit 1
fi

# Verify compiled test files exist
if [ ! -d "lua/longway-spec" ]; then
    echo "ERROR: Test files not compiled. lua/longway-spec/ directory missing."
    exit 1
fi

# Count compiled test files
test_file_count=$(find lua/longway-spec -name "*.lua" 2>/dev/null | wc -l)
if [ "$test_file_count" -eq 0 ]; then
    echo "ERROR: No compiled test files found in lua/longway-spec/"
    exit 1
fi

echo "Compilation complete. Found $test_file_count test files."
echo ""
echo "Running tests..."
echo ""

# Run tests using PlenaryBustedDirectory
nvim --headless \
    -u .test/init.lua \
    -c "PlenaryBustedDirectory lua/longway-spec { minimal_init = '.test/init.lua', sequential = true }"

exit_code=$?
echo ""
if [ $exit_code -eq 0 ]; then
    echo "All tests passed!"
else
    echo "Tests failed with exit code: $exit_code"
fi

exit $exit_code
