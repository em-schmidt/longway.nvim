#!/usr/bin/env bash
set -euo pipefail

# Isolate test environment from user config
export XDG_CONFIG_HOME="$(pwd)/.test"
export XDG_DATA_HOME="$(pwd)/.test"
export XDG_STATE_HOME="$(pwd)/.test"

echo "Compiling Fennel files..."

# Compile all Fennel files using nfnl's Lua API
# First trust the config file, then setup, then compile
nvim --headless \
    -u .test/init.lua \
    -c "lua require('nfnl.trust').trust(vim.fn.getcwd() .. '/.nfnl.fnl')" \
    -c "lua require('nfnl').setup()" \
    -c "lua require('nfnl.api')['compile-all-files']()" \
    -c "qa!"

compile_exit=$?
if [ $compile_exit -ne 0 ]; then
    echo "ERROR: Fennel compilation failed"
    exit 1
fi

# Verify compiled test files exist
if [ ! -d "lua/longway-spec" ]; then
    echo "ERROR: Test files not compiled. lua/longway-spec/ directory missing."
    echo "Check that nfnl is properly configured and .nfnl.fnl includes test patterns."
    exit 1
fi

# Count compiled test files
test_file_count=$(find lua/longway-spec -name "*.lua" 2>/dev/null | wc -l)
if [ "$test_file_count" -eq 0 ]; then
    echo "ERROR: No compiled test files found in lua/longway-spec/"
    exit 1
fi

echo "Compilation complete. Found $test_file_count test files."
echo ""
echo "Running tests..."
echo ""

# Run tests using PlenaryBustedDirectory
# In headless mode, Plenary should exit after tests complete
nvim --headless \
    -u .test/init.lua \
    -c "PlenaryBustedDirectory lua/longway-spec { minimal_init = '.test/init.lua', sequential = true }"

exit_code=$?
echo ""
if [ $exit_code -eq 0 ]; then
    echo "All tests passed!"
else
    echo "Tests failed with exit code: $exit_code"
fi

exit $exit_code
