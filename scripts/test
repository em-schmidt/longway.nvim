#!/usr/bin/env bash
set -euo pipefail

# Isolate test environment from user config
export XDG_CONFIG_HOME="$(pwd)/.test"
export XDG_DATA_HOME="$(pwd)/.test"
export XDG_STATE_HOME="$(pwd)/.test"

echo "Compiling Fennel files..."

# Compile all Fennel files first
nvim --headless \
    --noplugin \
    -u .test/init.lua \
    -c "lua require('nfnl').setup()" \
    -c "lua require('nfnl.api').compile_all_files()" \
    -c "qa"

echo "Running tests..."

# Run tests in headless Neovim
nvim --headless \
    --noplugin \
    -u .test/init.lua \
    -c "PlenaryBustedDirectory lua/longway-spec { minimal_init = '.test/init.lua' }"

echo "Tests complete!"
