#!/usr/bin/env bash
set -euo pipefail

# Compile all Fennel files to Lua using nfnl
# Run this locally after modifying .fnl files, then commit the .lua output

echo "Compiling Fennel files..."
echo "This requires nfnl to be installed and will prompt to trust .nfnl.fnl"
echo ""

if nvim --headless \
    -c "lua require('nfnl').setup()" \
    -c "lua local results = require('nfnl.api')['compile-all-files'](); local errors = 0; for _, r in ipairs(results or {}) do if r.status == 'error' then print('ERROR: ' .. (r['source-path'] or 'unknown') .. ': ' .. (r.error or 'unknown error')); errors = errors + 1 end end; if errors > 0 then print(errors .. ' file(s) failed to compile'); vim.cmd('cquit 1') else vim.cmd('qa!') end"; then
    echo ""
    echo "Done! Remember to commit the compiled lua/ files."
else
    echo ""
    echo "Compilation failed!"
    exit 1
fi
